<link rel="import" href="import.html">

<dom-module id="passenger-view">
	<template>
		<style include="rmd-view-styles"></style>


		<px-card id="myCard" header-text="">
		<div class="u-mh+">
				<px-alert-label id="online" type="important" label="Oops! It appears you are offline"></px-alert-label>
		</div>
		<iron-ajax id="onlineCall" handle-as="json"></iron-ajax>

			<px-steps id="steps"
			items='[{"id":"1","label":"Pick-up"},{"id":"2","label":"Waiting"},{"id":"3","label":"Confirmed"}]'>
		</px-steps>
		
		
		<span id="step0">

			<div class="u-mh+">
				<span class="heading--subsection u-mv++">Hi Sample User, where you want to go?</span>
				<div class="flex u-mv++">
					<div class="u-mr++ u-1/1">

						<label for="input1" ><px-icon icon="px-utl:location" class="style-scope px-actionable-design-demo x-scope px-icon-3"></px-icon> From (current):</label>
						<input id="input1" value="[[from]]" class="text-input input--huge validation-error" type="text">
					</div>
				</div>
				<div class="flex u-mv++">
					<div class="u-mr++ u-1/1">

						<label for="input2" ><px-icon icon="px-utl:download" class="style-scope px-actionable-design-demo x-scope px-icon-3"></px-icon> To:</label>
						<px-typeahead id="searchTo" placeholder="To ..." class="text-input input--huge validation-error" remote-url="api/rebu/l/locations?name=%QUERY" remote-url-searching="true"></px-typeahead>
					<!-- prefetch-url="https://www.predix-ui.com/px-typeahead/px-typeahead/countries.json" -->
					</div>
				</div>
				<div class="flex u-mv++">
					<div class="u-1/4">
						<label for="input1"><px-icon icon="px-utl:clock" class="style-scope px-actionable-design-demo x-scope px-icon-3"></px-icon> In:</label>
						<div class="flex">
							<px-dropdown items='["5 minutes","10 minutes","15 minutes","30 minutes","45 minutes"]' selected="0" button-style="bare"></px-dropdown>
						</div>
					</div>
				</div>
				<div class="flex u-mv++">
					<div class="u-1/4">
						<label for="input1"><px-icon icon="px-utl:overflow" class="style-scope px-actionable-design-demo x-scope px-icon-3"></px-icon> Peoples:</label>
						<div class="flex">
							<px-dropdown items='["1","2","3","4"]' selected="0" button-style="bare"></px-dropdown>
						</div>
					</div>
				</div>
				<div class="flex u-mv++">
					<div class="u-1/4">
						<button on-click="next" class="btn btn--full btn--primary"> OK
							<px-icon icon="px-utl:check" class="style-scope px-actionable-design-demo x-scope px-icon-3"></px-icon>
						</button>
					</div>
				</div>
				<!-- calls -->
				<iron-ajax id="locationsCall" handle-as="json"></iron-ajax>
				<iron-ajax id="tripsCall" handle-as="json"></iron-ajax>

			</div>
			</span>
			
			<span id="step1">
			<div class="u-mh+">
				<span class="heading--subsection u-mv++">Waiting for confirmation</span>
				<px-spinner	size="100">
						</px-spinner>
			</div>
			</span>
			<span id="step2">
				<span class="heading--subsection u-mv++">Timeline.</span>
			<div class="u-mh+">
  <px-timeline enhanced timeline-data='[{"metaData":{"editedBy":"User","editedDate":"2017-11-24 14:12:00-07","editorTitle":"User","percent":"100","customIcon":"px-doc:website"},"content":{"title":"Start Pick-Up","bodyType":"text","body":[{"text":"Pick-Up requeted from Local to Nuovo Pignone.","headline":"Pick-Up requeted from Local to Nuovo Pignone","isComment":true}]}},{"metaData":{"editedBy":"REBU","editedDate":"2017-11-24 14:13:00-07","editorTitle":"REBU","percent":"100","customIcon":"px-utl:clock"},"content":{"title":"Pick-Up Accepted","bodyType":"text","body":[{"text":"Pick-Up accpted by Driver 1.","headline":"Pick-Up accepted by Driver 1.","isComment":true}]}},{"metaData":{"editedBy":"Driver","editedDate":"2017-11-24 14:32:00-07","editorTitle":"Driver","customIcon":"px-utl:download"},"content":{"title":"Expected Pick-up within 20 mins","bodyType":"text","body":[{"text":"Expected Pick-up within 20 mins.","headline":"Expected Pick-up within 20 mins.","isComment":true}]}}]' date-format="MMM D, YYYY HH:MM"></px-timeline>
 			</div>

 			<button id="confirm" on-click="next" class="btn btn--full btn--primary"> Confirm
				<px-icon icon="px-utl:check" class="style-scope px-actionable-design-demo x-scope px-icon-3"></px-icon>
			</button>


 			<button id="cancel" on-click="cancel" class="btn btn--full btn--primary"> Cancel
				<px-icon icon="px-utl:close" class="style-scope px-actionable-design-demo x-scope px-icon-3"></px-icon>
			</button>

			</span>
		</px-card>

	</template>
</template>
<script>
	Polymer({
		is: 'passenger-view',
		properties: {
			from: {
				type: String,
				value: "unknown"
			},
			to: {
				type: String,
				value: "unknown"
			},
			step: {
				type: Number,
				notify: true,
				value: 0,
				observer : ['stepgo']
			}
		},
		next : function() {
			console.log('next');
			this.$.steps.complete();

			console.log(this.get('step'));
			this.set('step', this.get('step')+1);
			console.log(this.get('step'));

		},
		stepgo : function(id)
		{
			console.log(id);
			if (id===0) {
				this.$.step0.hidden=false;
				this.$.step1.hidden=true;
				this.$.step2.hidden=true;
			} else if (id===1) {
				this.$.step0.hidden=true;
				this.$.step1.hidden=false;
				this.$.step2.hidden=true;
				this.checkConfirmation();
			} else if (id===2) {
				this.$.step0.hidden=true;
				this.$.step1.hidden=true;
				this.$.step2.hidden=false;
				this.$.confirm.hidden=false;
				this.$.cancel.hidden=true;
			} else if (id===3) {
				this.$.step0.hidden=true;
				this.$.step1.hidden=true;
				this.$.step2.hidden=false;
				this.$.confirm.hidden=true;
				this.$.cancel.hidden=false;
			}
		},
		cancel : function() {
			this.set('step', 0);
			this.$.steps.jumpToStep(0);
			this.$.steps.completed=[];
		},
		checkConfirmation : function() {
			var that = this;

			setTimeout(function() {
				that.$.tripsCall.generateRequest();
			}, 5000);


		},
		checkTripStatus : function() {
			const trips = this.get('trips');
			if (trips.length>0) {
				console.log(trips[0].status);
				if (trips[0].status == 'confirmed') {
					this.stepgo(3);
				} else if (trips[0].status == 'accepted') {
					this.stepgo(2);
				} else if (trips[0].status == 'pending') {
					this.stepgo(1);
				} else {
					this.stepgo(0);
				}
				
			}
		},
		ready: function(e) {
			var that = this;

			setTimeout(function() {
				if (navigator.geolocation) {;
					navigator.geolocation.watchPosition(function(position) {
						that.set('from', "Lat: " + position.coords.latitude + " Lng: " + position.coords.longitude);
					});
				} else {
					that.set('from', "Geolocation is not supported by this browser.");
				}
			}, 1000);


 		this.$.locationsCall.url = "mock/rebu/locations";

		this.$.locationsCall.addEventListener('response', function (evt) {
          this.locations = evt.detail.response;
          console.log(evt.detail.response);
        }.bind(this));

        this.$.locationsCall.generateRequest();


        var passengerid = '212442540';

        this.$.tripsCall.url = "mock/rebu/trips";
        //this.$.tripsCall.params = {"status":"new","passengerid":passengerid};

		this.$.tripsCall.addEventListener('response', function (evt) {
          this.trips = evt.detail.response;
          console.log('evt.detail.response');
          this.checkTripStatus();
          
        }.bind(this));

       this.$.tripsCall.generateRequest();

		this.$.onlineCall.url = "api/rebu/health";
        //this.$.tripsCall.params = {"status":"new","passengerid":passengerid};

		this.$.onlineCall.addEventListener('response', function (evt) {
		console.log(evt);
          this.online = evt.detail.response.status;
          this.$.online.hidden=true;
          
        }.bind(this));

        this.$.onlineCall.addEventListener('error', function (evt) {
		  console.log(evt);
          this.online = 'not connected';
          this.$.online.hidden=false;
        }.bind(this));

       this.$.onlineCall.generateRequest();

       this.$.searchTo.addEventListener('px-typeahead-search-input-change', function (evt) {
		  console.log(evt);
        }.bind(this));


		}
	});
</script>
</dom-module>
